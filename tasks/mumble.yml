---

- name: check if murmurd is already installed.
  stat:
    path: /usr/sbin/murmurd
  register: murmurd_installed

- name: ensure required packages are present
  apt:
    pkg: mumble-server

- name: generate the Murmur config file
  template:
    src: "mumble-server.ini.j2"
    dest: "/etc/mumble-server.ini"
    owner: root
    group: mumble-server
    mode: 0640
  notify: restart murmur

- service:
    name: mumble-server
    enabled: True
    state: started

- name: write superuser password to a file
  copy:
    content: "{{ murmur_superuser_password }}"
    dest: /etc/mumble-superuser
    owner: root
    group: root
    mode: 0600
  when: murmur_superuser_password is defined
  register: superuser

- name: set the superuser password [not idempodent]
  shell: murmurd -ini /etc/mumble-server.ini -supw "{{ murmur_superuser_password }}"
  when: superuser.changed
